<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phony - Agent Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .agent-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s;
        }
        .agent-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .agent-card.inbound {
            border-left-color: #28a745;
        }
        .agent-card.outbound {
            border-left-color: #17a2b8;
        }
        .agent-card.inactive {
            border-left-color: #6c757d;
            opacity: 0.7;
        }
        .status-badge.active {
            background-color: #28a745;
        }
        .status-badge.inactive {
            background-color: #6c757d;
        }
        .context-editor {
            max-height: 300px;
            overflow-y: auto;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .phone-number-card {
            border: 2px dashed #dee2e6;
            transition: all 0.3s;
        }
        .phone-number-card.assigned {
            border-color: #28a745;
            border-style: solid;
            background-color: #f8f9fa;
        }
        .spinner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/dashboard/">
                    <i class="fas fa-robot"></i> Phony Agent Management
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/dashboard/">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </div>
            </div>
        </nav>

        <!-- Loading Spinner -->
        <div class="spinner-container" id="loadingSpinner">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="totalAgents">0</h3>
                        <p class="mb-0">Total Agents</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="inboundAgents">0</h3>
                        <p class="mb-0">Inbound Agents</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="outboundAgents">0</h3>
                        <p class="mb-0">Outbound Agents</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="availableNumbers">0</h3>
                        <p class="mb-0">Available Numbers</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col">
                <button class="btn btn-primary me-2" onclick="showCreateAgentModal()">
                    <i class="fas fa-plus"></i> Create Agent
                </button>
                <button class="btn btn-secondary me-2" onclick="loadPhoneNumbers()">
                    <i class="fas fa-phone"></i> Manage Phone Numbers
                </button>
                <button class="btn btn-info" onclick="loadAgents()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Agents List -->
        <div class="row" id="agentsList">
            <!-- Agents will be loaded here -->
        </div>
    </div>

    <!-- Create/Edit Agent Modal -->
    <div class="modal fade" id="agentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agentModalTitle">Create Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="agentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Agent Name</label>
                                    <input type="text" class="form-control" id="agentName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Agent Type</label>
                                    <select class="form-control" id="agentType" required onchange="togglePhoneNumberField()">
                                        <option value="">Select Type</option>
                                        <option value="inbound">Inbound (Receives Calls)</option>
                                        <option value="outbound">Outbound (Makes Calls)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row" id="phoneNumberRow" style="display: none;">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <select class="form-control" id="agentPhoneNumber">
                                        <option value="">Select Phone Number</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Voice</label>
                                    <select class="form-control" id="agentVoice">
                                        <option value="alloy">Alloy (Default)</option>
                                        <option value="echo">Echo (Male)</option>
                                        <option value="fable">Fable (British)</option>
                                        <option value="onyx">Onyx (Deep Male)</option>
                                        <option value="nova">Nova (Female)</option>
                                        <option value="shimmer">Shimmer (Female)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Personality</label>
                                    <input type="text" class="form-control" id="agentPersonality" 
                                           placeholder="e.g., Friendly, Professional, Witty">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">System Prompt</label>
                            <textarea class="form-control" id="agentSystemPrompt" rows="4" 
                                      placeholder="You are a helpful AI assistant..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Greeting Message (Optional)</label>
                            <textarea class="form-control" id="agentGreeting" rows="2" 
                                      placeholder="Hello! How can I help you today?"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Context Data (JSON)</label>
                            <textarea class="form-control" id="agentContextData" rows="4" 
                                      placeholder='{"key": "value", "instructions": "Special instructions for this agent"}'>{}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAgent()">Save Agent</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Edit Modal -->
    <div class="modal fade" id="contextModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Agent Context</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="contextNotes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Context Data (JSON)</label>
                        <textarea class="form-control context-editor" id="contextData" rows="8"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveContext()">Save Context</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone Numbers Modal -->
    <div class="modal fade" id="phoneModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Phone Number Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="phoneNumbersList">
                        <!-- Phone numbers will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAgentId = null;
        let agents = [];
        let phoneNumbers = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadAgents();
            loadAvailablePhoneNumbers();
        });

        function showSpinner() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }

        function hideSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        async function loadAgents() {
            showSpinner();
            try {
                const response = await fetch('/agents/');
                agents = await response.json();
                displayAgents();
                updateStats();
            } catch (error) {
                console.error('Error loading agents:', error);
                alert('Error loading agents');
            } finally {
                hideSpinner();
            }
        }

        function displayAgents() {
            const container = document.getElementById('agentsList');
            
            if (agents.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No agents created yet. Click "Create Agent" to get started!</div></div>';
                return;
            }

            container.innerHTML = agents.map(agent => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card agent-card ${agent.type} ${agent.status}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>${agent.name}</strong>
                            <span class="badge status-badge ${agent.status}">${agent.status}</span>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>Type:</strong> ${agent.type.charAt(0).toUpperCase() + agent.type.slice(1)}</p>
                            <p class="mb-1"><strong>Voice:</strong> ${agent.voice}</p>
                            ${agent.phone_number ? `<p class="mb-1"><strong>Phone:</strong> ${agent.phone_number}</p>` : ''}
                            ${agent.personality ? `<p class="mb-1"><strong>Personality:</strong> ${agent.personality}</p>` : ''}
                            <p class="mb-1"><strong>Calls:</strong> ${agent.total_calls} (${agent.total_minutes} min)</p>
                            
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="editAgent('${agent.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="editContext('${agent.id}')">
                                    <i class="fas fa-cogs"></i> Context
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAgent('${agent.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalAgents').textContent = agents.length;
            document.getElementById('inboundAgents').textContent = agents.filter(a => a.type === 'inbound').length;
            document.getElementById('outboundAgents').textContent = agents.filter(a => a.type === 'outbound').length;
        }

        async function loadAvailablePhoneNumbers() {
            try {
                const response = await fetch('/agents/phone-numbers/available');
                const available = await response.json();
                document.getElementById('availableNumbers').textContent = available.length;
                
                // Update phone number dropdown
                const select = document.getElementById('agentPhoneNumber');
                select.innerHTML = '<option value="">Select Phone Number</option>' +
                    available.map(num => `<option value="${num.phone_number}">${num.phone_number} (${num.friendly_name || 'No name'})</option>`).join('');
            } catch (error) {
                console.error('Error loading phone numbers:', error);
            }
        }

        function showCreateAgentModal() {
            currentAgentId = null;
            document.getElementById('agentModalTitle').textContent = 'Create Agent';
            document.getElementById('agentForm').reset();
            document.getElementById('agentContextData').value = '{}';
            document.getElementById('phoneNumberRow').style.display = 'none';
            new bootstrap.Modal(document.getElementById('agentModal')).show();
        }

        function togglePhoneNumberField() {
            const type = document.getElementById('agentType').value;
            const phoneRow = document.getElementById('phoneNumberRow');
            phoneRow.style.display = type === 'inbound' ? 'block' : 'none';
        }

        async function editAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;

            currentAgentId = agentId;
            document.getElementById('agentModalTitle').textContent = 'Edit Agent';
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentType').value = agent.type;
            document.getElementById('agentVoice').value = agent.voice;
            document.getElementById('agentPersonality').value = agent.personality || '';
            document.getElementById('agentSystemPrompt').value = agent.system_prompt;
            document.getElementById('agentGreeting').value = agent.greeting_message || '';
            document.getElementById('agentContextData').value = JSON.stringify(agent.context_data, null, 2);
            
            togglePhoneNumberField();
            if (agent.phone_number) {
                // Add current phone number to dropdown if not there
                const select = document.getElementById('agentPhoneNumber');
                if (!Array.from(select.options).some(opt => opt.value === agent.phone_number)) {
                    select.innerHTML += `<option value="${agent.phone_number}" selected>${agent.phone_number} (Current)</option>`;
                }
                select.value = agent.phone_number;
            }
            
            new bootstrap.Modal(document.getElementById('agentModal')).show();
        }

        async function saveAgent() {
            try {
                const formData = {
                    name: document.getElementById('agentName').value,
                    type: document.getElementById('agentType').value,
                    voice: document.getElementById('agentVoice').value,
                    personality: document.getElementById('agentPersonality').value,
                    system_prompt: document.getElementById('agentSystemPrompt').value,
                    greeting_message: document.getElementById('agentGreeting').value,
                    context_data: JSON.parse(document.getElementById('agentContextData').value),
                };

                if (formData.type === 'inbound') {
                    formData.phone_number = document.getElementById('agentPhoneNumber').value;
                }

                let response;
                if (currentAgentId) {
                    // Update existing agent
                    response = await fetch(`/agents/${currentAgentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Create new agent
                    response = await fetch('/agents/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('agentModal')).hide();
                    loadAgents();
                    loadAvailablePhoneNumbers();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error saving agent:', error);
                alert('Error saving agent');
            }
        }

        async function editContext(agentId) {
            try {
                const response = await fetch(`/agents/${agentId}/context`);
                const context = await response.json();
                
                currentAgentId = agentId;
                document.getElementById('contextNotes').value = context.notes || '';
                document.getElementById('contextData').value = JSON.stringify(context.context_data, null, 2);
                
                new bootstrap.Modal(document.getElementById('contextModal')).show();
            } catch (error) {
                console.error('Error loading context:', error);
                alert('Error loading context');
            }
        }

        async function saveContext() {
            try {
                const contextData = {
                    notes: document.getElementById('contextNotes').value,
                    context_data: JSON.parse(document.getElementById('contextData').value)
                };

                const response = await fetch(`/agents/${currentAgentId}/context`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contextData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('contextModal')).hide();
                    loadAgents();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error saving context:', error);
                alert('Error saving context');
            }
        }

        async function deleteAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent || !confirm(`Delete agent "${agent.name}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/agents/${agentId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAgents();
                    loadAvailablePhoneNumbers();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deleting agent:', error);
                alert('Error deleting agent');
            }
        }

        async function loadPhoneNumbers() {
            try {
                const response = await fetch('/agents/phone-numbers/all');
                phoneNumbers = await response.json();
                displayPhoneNumbers();
                new bootstrap.Modal(document.getElementById('phoneModal')).show();
            } catch (error) {
                console.error('Error loading phone numbers:', error);
                alert('Error loading phone numbers');
            }
        }

        function displayPhoneNumbers() {
            const container = document.getElementById('phoneNumbersList');
            
            container.innerHTML = phoneNumbers.map(phone => `
                <div class="phone-number-card card mb-2 ${phone.assigned_agent_id ? 'assigned' : ''}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <strong>${phone.phone_number}</strong>
                                <br><small class="text-muted">${phone.friendly_name}</small>
                            </div>
                            <div class="col-md-4">
                                ${phone.assigned_agent_id ? 
                                    `<span class="badge bg-success">Assigned</span>` : 
                                    `<span class="badge bg-secondary">Available</span>`
                                }
                                <br><small>${phone.capabilities.join(', ')}</small>
                            </div>
                            <div class="col-md-4 text-end">
                                ${phone.assigned_agent_id ? 
                                    `<button class="btn btn-sm btn-outline-warning" onclick="unassignPhone('${phone.phone_number}')">Unassign</button>` :
                                    `<button class="btn btn-sm btn-outline-success" onclick="assignPhone('${phone.phone_number}')">Assign</button>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function assignPhone(phoneNumber) {
            // Show available inbound agents
            const inboundAgents = agents.filter(a => a.type === 'inbound' && !a.phone_number);
            
            if (inboundAgents.length === 0) {
                alert('No available inbound agents to assign this number to.');
                return;
            }

            const agentId = prompt(`Assign ${phoneNumber} to which agent?\n\n` + 
                inboundAgents.map((a, i) => `${i + 1}. ${a.name} (${a.id})`).join('\n') +
                '\n\nEnter the agent ID:');

            if (!agentId) return;

            try {
                const response = await fetch('/agents/phone-numbers/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: phoneNumber, agent_id: agentId })
                });

                if (response.ok) {
                    loadPhoneNumbers();
                    loadAgents();
                    loadAvailablePhoneNumbers();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error assigning phone:', error);
                alert('Error assigning phone number');
            }
        }

        async function unassignPhone(phoneNumber) {
            if (!confirm(`Unassign ${phoneNumber}?`)) return;

            try {
                const response = await fetch(`/agents/phone-numbers/${encodeURIComponent(phoneNumber)}/unassign`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadPhoneNumbers();
                    loadAgents();
                    loadAvailablePhoneNumbers();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error unassigning phone:', error);
                alert('Error unassigning phone number');
            }
        }
    </script>
</body>
</html>